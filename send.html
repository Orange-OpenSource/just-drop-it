<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
   <title>Just drop it</title>
    
        <!-- Boost -->
    <link rel="stylesheet" href="css/bootstrap-orange.css" />
    <link rel="stylesheet" href="css/bootstrap-orange-theme.css" />
    <link rel="stylesheet" href="css/boost.css">
    <link rel="stylesheet" href="css/my.css">
    
    <link rel="icon" type="image/png" href="images/favicon.png" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
     <div class="container">
      <div class="header">
             <!--<nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class="active"><a href="#">Home</a></li>
            <li role="presentation"><a href="#">About</a></li>
            <li role="presentation"><a href="#">Contact</a></li>
          </ul>
        </nav>-->
        <h3 class="text-muted">Just drop it</h3>
      </div>
         <br>
     <div class="jumbotron" id="intro">
        <p class="lead">This page allows you to simply beam a file to a colleague. You and your correspondant must be in front of yours browsers at the same time. Nothing is stored on any server.</p>
  
					<form class="form-inline" id="nameForm" action="">
                          <fieldset>
                              <p>
                        <!--<label for="cname">Name (required, at least 2 characters)</label>-->
                        <input id="cname" class="form-control"  name="name" minlength="2" type="text" required placeholder="your name">

						<button type="submit" class="btn  btn-lg btn-success" >Start now!</button>
                                  </p>
                                </fieldset>
					</form>

      </div>
         

         <div class="alert alert-danger" role="alert"  id='error'>...</div>
         
        <div class="row marketing" >
               <div class="col-lg-10" id="step0">
                  <h3>Hello <span id="username">you</span></h3>
                  <p>Let's follow some simple step to transfer your file.</p>

             </div>  
            
            <div class="list-group">
            
             <div class="col-lg-8  col-md-offset-1 list-group-item" id="step1-wait" >
                  <h4>Step 1</h4>
                  <p>First, you will need to tell your friend to go to this url:</p>
                  <div class="row">
                      <div class="col-md-4" id="generatedurl"></div>
                 </div>
                  <button id="copy-button" data-clipboard-text="Copy Me!" title="Click to copy url to clipboard">Copy to clipoard</button>
                  <span class=warning id="clipboardcopyok"> successfully copied to clipboard!</span>
                  <h4 id="status_connection"></h4>
             </div>  
            
              <div class="col-lg-8 col-md-offset-1 list-group-item" id="step2-selectfile">
                  <h4>Step 2</h4>
                  <p>Your friend is now in front of his browser, waiting for its file. Please select one:</p>
                  
                   <div class="upload-drop-zone" id="drop-zone">
                        Just drag and drop a file here
                    </div>
  
                  <form id="myform" action="">
                        or select a file below:<br>
                 <input type="file" id="file"  size="40">
               </form>
              
         
             </div>    
            
             <div class="col-lg-8  col-md-offset-1 list-group-item " id="step3-transfert">
                  <h4>Step 3</h4>
                  <p>Transfert in progress...</p>
                    <div class="progress ">
                        <div id="transfertpb" class="progress-bar  progress-bar-striped active" role="progressbar" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: 60%;"> 5%</div>
                </div>       
            </div> 
                 
           
            </div> <!--div listgroup-->
         
          <div class="col-lg-10" id="step4-outro">
                  <h4>Done</h4>
                  <p> <span id="colleaguename">Your friend</span> did receive the file. You can close this page now. </p>
                <h3>Thank you!</h3>
                </div>
</div>
               
                 
           
    
                  </div>
      </div>

    </div> <!-- /container -->
<br>
   <footer class="footer">
      <div class="container">
        <p class="text-muted">&copy; Arnaud Ruffin 2015</p>
      </div>
    </footer>
           
    
</body>
 
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script>
     $('#step0').hide();
     $('#step1-wait').hide();
     $('#step2-selectfile').hide();
     $("#clipboardcopyok").hide();
    $('#step3-transfert').hide();
     $('#step4-outro').hide();
   $('#error').hide();
    
    
</script>
<!-- jQuery validate -->
 <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/jquery.validate.min.js"></script>
 <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="js/socket.io-stream.js"></script>
  <script src="js/boost.js"></script>
<script src="js/ZeroClipboard.min.js"></script>

    
    
    <script>

        
        //____ Handling of copy to clipboard with zeroclipboard
        var client = new ZeroClipboard( document.getElementById("copy-button") );
        client.on( "ready", function( readyEvent ) {
            client.on( "aftercopy", function( event ) {
                $("#clipboardcopyok").show(300);
            } );
        } );
        
        var socket;

       
        //----- Handling drag and drop zone style
      


        $('#drop-zone').on('dragover',  function(e) {
            this.className = 'upload-drop-zone drop';
            return false;
        });

        $('#drop-zone').on('dragleave',  function(e) {
            this.className = 'upload-drop-zone';
            return false;
        });


        
     $("#nameForm").validate();
      
        //soumission du nom
     $("#nameForm").on("submit", function (e) {
          e.preventDefault();
          var userID = $('#cname').val();
         
          $('#intro').hide(100);
          $('#step0').show(100);
          $('#step1-wait').show(300);
          $('#username').html(userID);
          
          //init du socket vers le serveur
           if(window.location.hostname == "127.0.0.1"){
           socket = io({query: 'userID='+String(userID)+'&role=sender'});
        }else{
           socket = io({query: 'userID='+String(userID)+'&role=sender',path:"/_ws/socket.io/"});
        }
         
          <!-- when connection is confirmed-->
      socket.on('receive_url_ready', function(url){
          $('#generatedurl').html("<p>"+window.location.host+url+"<p>");
          ZeroClipboard.setData( "text/plain", window.location.host+url );
          $('#status_connection').html("Waiting for connection...")
      });
        
      socket.on('receiver_ready', function(receiverName){
          $('#status_connection').html("Congratulation! "+receiverName+" is connected!")
          $('#step2-selectfile').show();
      });
        
       socket.on('alert', function(errorMsg){
          $('#error').html("Error: "+errorMsg);
      });
     });
        


        //soumission du fichier via formulaire
          $('#file').change(function(e) {
              startUpload(e.target.files);
        });
        
        //soumission du fichier via drag and drop
         $('#drop-zone').on('drop',  function(e) {
            if(e.originalEvent.dataTransfer){
                if(e.originalEvent.dataTransfer.files.length) {
                    e.preventDefault();
                    e.stopPropagation();
                    /*UPLOAD FILES HERE*/
                    this.className = 'upload-drop-zone';
                    startUpload(e.originalEvent.dataTransfer.files);
                }   
            } 
        });
        
        //fonction d'upload du fichier
        var startUpload = function(files) {
            //pour l'instant on se limite au premier si plusieurs
            var file = files[0];
            console.log(file);
            
             $('#myform').hide(100);
             $('#drop-zone').hide(100);
             $('#step3-transfert').show(300);
            
            var stream = ss.createStream();

            // upload a file to the server.
            ss(socket).emit('send_file', stream, {size: file.size ,name : file.name});
     
            var blobStream = ss.createBlobReadStream(file);
            var size = 0;

            blobStream.on('data', function(chunk) {
                size += chunk.length;
                //console.log(Math.floor(size / file.size * 100) + '%');
                var progress = Math.floor(size / file.size * 100);
              
                socket.emit('transfert_in_progress',progress);
                
                //update progress bar
                $("#transfertpb").attr('aria-valuenow',progress);
                $("#transfertpb").width(progress + '%');
                $('#transfertpb').html( progress+ '%');

                if(progress == 100){
                   $('#step4-outro').show(300);
                }
            });

            blobStream.pipe(stream);
        }
       
        
    </script>

    
    
</html>
