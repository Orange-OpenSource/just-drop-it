<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
   <title>Just drop it</title>
    
        <!-- Boost -->
    <link rel="stylesheet" href="css/bootstrap-orange.css" />
    <link rel="stylesheet" href="css/bootstrap-orange-theme.css" />
    <link rel="stylesheet" href="css/boost.css">
     <link rel="stylesheet" href="css/my.css">
    
    <link rel="icon" type="image/png" href="images/favicon.png" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
     <div class="container">
      <div class="header">
        <!--<nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class="active"><a href="#">Home</a></li>
            <li role="presentation"><a href="#">About</a></li>
            <li role="presentation"><a href="#">Contact</a></li>
          </ul>
        </nav>-->
        <h3 class="text-muted">Just drop it</h3>
      </div>
         
          <div class="alert alert-danger" role="alert"  id='error'>...</div>
         
         
            <div class="row marketing" >
               <div class="col-lg-10" id="step0">
                  <h3>Hello <span class="username"></span></h3>
                  <p>Apparently someone wants to send you a file</p>

             </div>  
            
            <div class="list-group">
            
             <div class="col-lg-8  col-md-offset-1 list-group-item" id="step1-name" >
                  <h4>Step 1</h4>
                  <p>First, tell us your name:</p>
                  <form class="form-inline" id="nameForm" action="">
                          <fieldset>
                              <p>
                        <!--<label for="cname">Name (required, at least 2 characters)</label>-->
                        <input id="cname" class="form-control"  name="name" minlength="2" type="text" required placeholder="your name">

						<button type="submit" class="btn  btn-lg btn-success" >go!</button>
                                  </p>
                                </fieldset>
					</form>
                 <p id="nameconfirm">Hello <span class="username"></span></p>
             </div> 
                
                 <div class="col-lg-8  col-md-offset-1 list-group-item" id="step2-transfert" >
                  <h4>Step 2</h4>
                  <p id="step2-consigne"></p>
                  <div class="progress ">
                        <div id="transfertpb" class="progress-bar  progress-bar-striped active" role="progressbar" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: 60%;"> 5%</div>
                </div>    
                 
             </div> 
                
            </div>
                
                          <div class="col-lg-10" id="step4-outro">
                  <h4>Done</h4>
                  <p> The file is downloaded. You can close this page now. </p>
                <h3>Thank you!</h3>
                </div>
         </div>
         
         
      </div> <!-- /container -->
    <br>
   <footer class="footer">
      <div class="container">
        <p class="text-muted">&copy; Arnaud Ruffin 2015</p>
      </div>
    </footer>   
         
         
    <div id='error'></div>

</body>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="js/boost.js"></script>
    
    
  <script src="js/socket.io-stream.js"></script>

    
    
    <script>
    $('#error').hide();
    $('.progress').hide();
    $('#step2-transfert').hide();
         $("#nameconfirm").hide();
        $('#step4-outro').hide();
    var socket;
       
        
        
    //Ã  la soumission du nom, on init tout ce qui concerne les sockets
     $("#nameForm").on("submit", function (e) {

          e.preventDefault();
          var userID = $('#cname').val();
         
          $("#nameForm").hide();
          $(".username").html(userID);
           $("#nameconfirm").show(300);
           $("#step2-transfert").show(300);
         
         
         
          //pour l'instant le senderID est directement dans l'URL
        var senderID = window.location.pathname.replace('/', '');
        if(window.location.hostname == "127.0.0.1"){
           socket = io({query: 'userID='+userID+'&senderID='+senderID+'&role=receiver'});
        }else{
           socket = io({query: 'userID='+userID+'&senderID='+senderID+'&role=receiver',path:"/_ws/socket.io/"});
        }
         
          socket.on('alert', function(errorMsg){
              $('#error').html("Error: "+errorMsg);
          });

          socket.on('connection_ready', function(senderName){
               $('#step2-consigne').html(senderName+" has been notified of your connection. Please wait while he selects his file.");
          });  


          ss(socket).on('forward_file', function(stream, data) {
               $('#step2-consigne').html("Receiving file");
               //stream.pipe(this);
          });  

         socket.on('stream_ready', function(url){
              $('#step2-consigne').html("Begining download");
             $('.progress').show();
             //window.open(url);
             //window.location.href = url;

             var popup = window.open(url);
             popup.blur();
             window.focus();     

               //$('#error').load(url);
          });  

        socket.on('transfert_in_progress', function(progress){
            
            
              //update progress bar
                $("#transfertpb").attr('aria-valuenow',progress);
                $("#transfertpb").width(progress + '%');
                $('#transfertpb').html( progress+ '%');

                if(progress == 100){
                   $('#step4-outro').show(300);
                }
  
        });
     });


     
        
          

    </script>

    
    
</html>
